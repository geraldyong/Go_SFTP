services:
  vault:
    image: hashicorp/vault:1.21
    container_name: vault
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: root
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
    ports:
      - "8200:8200"
    healthcheck:
      test: ["CMD", "sh", "-c", "wget -qO- http://127.0.0.1:8200/v1/sys/health > /dev/null"]
      interval: 3s
      timeout: 2s
      retries: 30

  # One-shot: fix the data directory.
  datainit:
    image: debian:bookworm-slim
    container_name: sftp-server-init
    command: >
      sh -c "
        mkdir -p /data &&
        chown -R 65532:65534 /data
      "
    volumes:
      - sftp-data:/data
    restart: "no"

  # One-shot: generates the SSH host key into a shared volume
  hostkeygen:
    image: debian:bookworm-slim
    container_name: sftp-server-hostkeygen
    command: >
      sh -c "
        apt-get update &&
        apt-get install -y --no-install-recommends openssh-client &&
        rm -rf /var/lib/apt/lists/* &&
        if [ ! -f /keys/ssh_host_ed25519_key ]; then
          ssh-keygen -t ed25519 -f /keys/ssh_host_ed25519_key -N '' ;
        fi
        chown 65532:65534 /keys/ssh_host_ed25519_key /keys/ssh_host_ed25519_key.pub ;
        chmod 600 /keys/ssh_host_ed25519_key ;
        chmod 644 /keys/ssh_host_ed25519_key.pub ;
      "
    volumes:
      - sftp-keys:/keys
    restart: "no"

  # One-shot: writes a sample user record into Vault KV v2
  # Creates: kv/sftp/users/alice  (public key in ./dev/alice.pub)
  vault-init:
    image: curlimages/curl:8.18.0
    container_name: vault-init
    depends_on:
      vault:
        condition: service_healthy
    environment:
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
    volumes:
      - ./dev:/seed:ro
    command: >
      sh -c '
        set -e;
        echo "Enabling KV v2 at path kv (ignore error if already enabled)...";
        curl -sS -o /dev/null -w "%{http_code}\n" \
          -X POST "$$VAULT_ADDR/v1/sys/mounts/kv" \
          -H "X-Vault-Token: $$VAULT_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"type\":\"kv\",\"options\":{\"version\":\"2\"}}" || true;

        echo "Writing user alice...";
        PUBKEY=$$(cat /seed/*.pub | head -n 1);
        curl -sS -o /dev/null -w "%{http_code}\n" \
          -X POST "$$VAULT_ADDR/v1/kv/data/sftp/users/alice" \
          -H "X-Vault-Token: $$VAULT_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{\"data\":{\"username\":\"alice\",\"disabled\":false,\"rootSubdir\":\"alice\",\"publicKeys\":[\"$${PUBKEY}\"]}}";
        echo "Done.";
      '
    restart: "no"

  sftp-server:
    build:
      context: ./services/sftp-server
    container_name: sftp-server
    depends_on:
      datainit:
        condition: service_completed_successfully
      hostkeygen:
        condition: service_completed_successfully
      vault:
        condition: service_healthy
      vault-init:
        condition: service_completed_successfully
    environment:
      LISTEN_ADDR: 0.0.0.0:2022
      DATA_ROOT: /data
      HOST_KEY_PATH: /keys/ssh_host_ed25519_key
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      VAULT_USERS_PREFIX: kv/sftp/users
      DEFAULT_QUOTA_BYTES: "10485760"    # 10 MiB
      DEFAULT_QUOTA_FILES: "50"         # 50 files
      METRICS_ADDR: 0.0.0.0:9090
      METRICS_PATH: /metrics
      METRICS_INCLUDE_USER: "false"
    ports:
      - "2022:2022"
      - "9090:9090"
    volumes:
      - sftp-data:/data
      - sftp-keys:/keys:ro

  # Optional: Admin API (writes to Vault)
  admin-api:
    build:
      context: ./services/admin-api
    container_name: admin-api
    depends_on:
      vault:
        condition: service_healthy
    environment:
      LISTEN_ADDR: 0.0.0.0:8080
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      VAULT_USERS_PREFIX: kv/sftp/users
    ports:
      - "8080:8080"

  # Optional: Web UI
  web-ui:
    build:
      context: ./services/web-ui
    container_name: web-ui
    depends_on:
      - admin-api
    environment:
      ADMIN_API_BASE_URL: http://admin-api:8080
    ports:
      - "3000:3000"

volumes:
  sftp-data:
  sftp-keys:
